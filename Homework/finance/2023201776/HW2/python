from docxtpl import DocxTemplate
import os
import pandas as pd

# ---------- æ–‡ä»¶è·¯å¾„é…ç½® ----------
uni_file = r"D:\äººå·¥æ™ºèƒ½\å¤§å­¦æ’å.xlsx"    # å¤§å­¦åˆ—è¡¨Excelï¼ˆå«universityåˆ—ï¼‰
field_file = r"D:\äººå·¥æ™ºèƒ½\é¢†åŸŸ.xlsx"      # ç ”ç©¶é¢†åŸŸExcelï¼ˆå«field/journal1ç­‰åˆ—ï¼‰
template_file = r"D:\äººå·¥æ™ºèƒ½\æ¨¡æ¿.docx"   # ç”³è¯·ä¿¡æ¨¡æ¿ï¼ˆå«{{university}}/{{journal1}}ç­‰å ä½ç¬¦ï¼‰
output_dir = r"D:\äººå·¥æ™ºèƒ½\ä¸ªäººæ¨¡æ¿"    # æœ€ç»ˆç”³è¯·ä¿¡ä¿å­˜ç›®å½•
# ---------- è¯»å–Excelæ•°æ® ----------
universities = pd.read_excel(uni_file)   # å¤§å­¦æ•°æ®ï¼ˆæ¯è¡Œå¯¹åº”ä¸€æ‰€å¤§å­¦ï¼‰
fields = pd.read_excel(field_file)       # ç ”ç©¶é¢†åŸŸæ•°æ®ï¼ˆæ¯è¡Œå¯¹åº”ä¸€ä¸ªç ”ç©¶æ–¹å‘ï¼‰

# ---------- ä¸ªäººå›ºå®šä¿¡æ¯ ----------
personal_info = {
    "full_name": "Yongze Liu",
    "program": "Master of Finance",
    "career": "quant",
    "skill1": "Python",
    "skill2": "SQL",
    "skill3": "Math",
    "skill4": "PowerBI",
    "skill5": "Tableau",
    "academic_environment": "strong academic environment",
    "approach": "research-oriented approach",
}

# ---------- ç¡®ä¿è¾“å‡ºç›®å½•å­˜åœ¨ ----------
os.makedirs(output_dir, exist_ok=True)

# ---------- åŒé‡å¾ªç¯ç”Ÿæˆç”³è¯·ä¿¡ ----------
generated_count = 0  # æ§åˆ¶æœ€å¤šç”Ÿæˆ90ä»½
for _, uni_row in universities.iterrows():
    for _, field_row in fields.iterrows():
        # 1. æ„é€ ã€ŒåŠ¨æ€æ›¿æ¢ä¸Šä¸‹æ–‡ã€ï¼ˆåˆå¹¶ä¸ªäººä¿¡æ¯ + å¤§å­¦/é¢†åŸŸæ•°æ®ï¼‰
        context = {
            # ä¸ªäººå›ºå®šä¿¡æ¯ï¼ˆç›´æ¥å¤ç”¨ï¼‰
            **personal_info,  
            # åŠ¨æ€å¤§å­¦ä¿¡æ¯ï¼ˆä»Excelè¡Œä¸­æå–ï¼Œåˆ—åéœ€ä¸Excelä¸€è‡´ï¼‰
            "university": uni_row.get("university", ""),  
            # åŠ¨æ€ç ”ç©¶é¢†åŸŸ/æœŸåˆŠä¿¡æ¯ï¼ˆä»Excelè¡Œä¸­æå–ï¼Œåˆ—åéœ€ä¸Excelä¸€è‡´ï¼‰
            "field": field_row.get("field", ""),          
            "journal1": field_row.get("journal1", ""),
            "journal2": field_row.get("journal2", ""),
            "journal3": field_row.get("journal3", ""),
        }

        # 2. åŠ è½½æ¨¡æ¿å¹¶æ¸²æŸ“ï¼ˆæ¯æ¬¡å¾ªç¯é‡æ–°åŠ è½½ï¼Œé¿å…æ¸²æŸ“æ±¡æŸ“ï¼‰
        tpl = DocxTemplate(template_file)
        tpl.render(context)

        # 3. ç”Ÿæˆã€Œå®‰å…¨æ–‡ä»¶åã€ï¼ˆæ›¿æ¢ç©ºæ ¼/ç‰¹æ®Šå­—ç¬¦ï¼‰
        safe_uni = uni_row.get("university", "unknown").replace(" ", "_").replace("/", "_")
        safe_field = field_row.get("field", "unknown").replace(" ", "_")
        output_filename = f"application_{safe_uni}_{safe_field}.docx"
        output_path = os.path.join(output_dir, output_filename)

        # 4. ä¿å­˜æ–‡ä»¶
        tpl.save(output_path)
        print(f"âœ… ç”Ÿæˆç”³è¯·ä¿¡ï¼š{output_path}")

        # 5. æ§åˆ¶ç”Ÿæˆæ•°é‡ï¼ˆæœ€å¤š90ä»½ï¼‰
        generated_count += 1
        if generated_count >= 90:
            print("ğŸ‰ å·²ç”Ÿæˆ90ä»½ç”³è¯·ä¿¡ï¼Œä»»åŠ¡å®Œæˆ")
            break
    if generated_count >= 90:
        break
